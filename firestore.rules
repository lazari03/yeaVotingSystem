rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }
    
    function isJury() {
      return isAuthenticated() && getUserRole() == 'jury';
    }
    
    function isUser() {
      return isAuthenticated() && getUserRole() == 'user';
    }
    
    // Users collection
    match /users/{userId} {
      // Allow user creation during registration (when not authenticated)
      // This is necessary for the registration process
      allow create: if !isAuthenticated() || 
                      (isAuthenticated() && request.auth.uid == userId) ||
                      isAdmin();
      
      // Admins can read all users
      // Users can read their own document
      allow read: if isAuthenticated() && (isAdmin() || request.auth.uid == userId);
      
      // Users can update their own document, admins can update all
      allow update: if isAuthenticated() && (isAdmin() || request.auth.uid == userId);
      
      // Only admins can delete users
      allow delete: if isAdmin();
    }
    
    // Categories collection
    match /categories/{categoryId} {
      // All authenticated users can read categories
      allow read: if isAuthenticated();
      // Only admins can create, update, or delete categories
      allow write: if isAdmin();
    }
    
    // Criteria collection
    match /criteria/{criteriaId} {
      // All authenticated users can read criteria
      allow read: if isAuthenticated();
      // Only admins can create, update, or delete criteria
      allow write: if isAdmin();
    }
    
    // Teams collection
    match /teams/{teamId} {
      // All authenticated users can read teams
      allow read: if isAuthenticated();
      // Only admins can create, update, or delete teams
      allow write: if isAdmin();
    }
    
    // Competitions collection
    match /competitions/{competitionId} {
      // All authenticated users can read competitions
      allow read: if isAuthenticated();
      // Only admins can create, update, or delete competitions
      allow write: if isAdmin();
    }
    
    // Jury collection
    match /jury/{juryId} {
      // All authenticated users can read jury information
      allow read: if isAuthenticated();
      // Only admins can create, update, or delete jury members
      allow write: if isAdmin();
    }
    
    // Groups collection
    match /groups/{groupId} {
      // All authenticated users can read groups
      allow read: if isAuthenticated();
      // Only admins can create, update, or delete groups
      allow write: if isAdmin();
    }
    
    // Votes collection (if you add voting persistence)
    match /votes/{voteId} {
      // Users can read their own votes
      allow read: if isAuthenticated() && 
        (isAdmin() || resource.data.userId == request.auth.uid);
      // Jury and users can create votes, admins can do anything
      allow create: if isAuthenticated() && (isJury() || isUser());
      // Only the vote creator or admin can update
      allow update: if isAuthenticated() && 
        (isAdmin() || resource.data.userId == request.auth.uid);
      // Only admins can delete votes
      allow delete: if isAdmin();
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
